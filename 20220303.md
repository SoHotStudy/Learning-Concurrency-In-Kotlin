## 동시성 오류

멀티 쓰레드 환경에서는 여러 쓰레드가 공유되는 변수를 참조할 때 동시성 오류가 발생할 수 있다. 

이는 연산에 원자성이 없기 때문에 발생하는 문제이다.

### 원자성 위반

컴퓨터 입장에서 하나의 CPU 연산으로 처리될 수 있는 연산을 원자적이라고 한다.

`++` 연산은 아래와 같이 3가지 연산이 섞여 있기 때문에 원자적이지 않다.
- 메모리에서 변수의 값을 가져오는 연산
- 가져온 값을 증가시키는 연산
- 증가시킨 값을 메모리에 쓰는 연산

그렇기 때문에 여러 쓰레드가 공유되는 변수를 참조하여 `++` 연산을 할 때 아래 그림과 같이 값을 덮어쓰는 상황이 발생한다.

![image](https://user-images.githubusercontent.com/31586979/156486013-198853e7-db5e-47c6-9f21-6c47fd5360c1.png)

### Volatile

쓰레드는 CPU 위에서 동작하게 되고, CPU에서 메모리에 있는 데이터를 가져오기에는 너무 많은 시간이 소요된다. </br>
시간 소요를 줄이기 위해 CPU는 메모리까지 가지 않아도 데이터를 알 수 있도록 L2 캐시를 이용한다.

그래서 A 쓰레드가 메모리의 있는 값을 업데이트 해도, B 쓰레드는 L2 캐시를 참조하고 있어 아직 A가 업데이트한 값을 모를 수 있다.

Volatile을 이용하여 이러한 상황을 회피할 수 있다. </br>
Volatile은 L2 캐시를 이용하지 않고 직접 메모리에서 데이터를 가져다 쓰라고 지시한 것이기 때문에 항상 최신의 데이터를 읽어온다. </br>
하지만 Volatile은 최신 데이터만 참고할 뿐이지 연산이 원자적이지 않으면 덮어쓰는 문제가 발생하기 때문에 Volatile이 모든 동시성 오류를 해결해줄 수 없다.  </br>

## Thread Safe

멀티 쓰레드 환경에서는 위에서 설명한 것과 같이 동시성 이슈가 발생할 수 있다.

이를 해결하기 위한 방법을 소개한다.

### Single Thread

여러 쓰레드가 하나의 변수를 참조하면 문제가 될 수 있다. </br>
그렇다면 이를 회피하기 위한 가장 간단한 방법은 하나의 쓰레드만 해당 변수를 참조하고 변경하게 하면 된다. </br>
다른 쓰레드는 해당 쓰레드에게 변수의 변경 및 참조를 위임한다. </br>

### 임계영역

세마포어, 뮤텍스 혹은 자바의 경우 synchronized를 이용하여 하나의 쓰레드만 연산을 수행할 수 있도록 임계 영역을 설정할 수 있다. </br>
임계영역을 이용하여 동시에 변수가 변경되는 일이 없도록 코드를 작성할 수 있다. </br>

### Atomic한 기본 자료형

자바에서 Atomic한 기본 자료형을 지원해준다. </br>
Atomic 하다고 하지만 내부적으로는 synchronized를 이용했을 뿐이다. </br>

## Coroutine Thread Safe

Coroutine에서는 처음 소개된 것과 같은 동시성 이슈를 해결하기 위한 여러 방법을 제공해준다.

### Actor

Actor는 Channel과 Coroutine 컨텍스트, 실행 블록을 가지고 있는 일종의 Consumer로 여겨진다. </br>
> 행위자가 받는 메시지에 대응하여, 행위자는 자체적인 결정을 하고 더 많은 행위자를 만들며, 더 많은 메시지를 보내고, 다음에 받을 메시지에 대한 응답 행위를 결정할 수 있다. 행위자는 개인 상태를 수정할 수 있지만, 메시지를 통해서만 서로에게 영향을 줄 수 있다. (락의 필요성을 제거함) wikipedia
우리는 동시성을 회피하기 위한 방법으로 Single Thread 방식이 있다는 것을 알고 있다.  </br>

Actor의 한 요소인 Coroutine 컨텍스트를 싱글 쓰레드로 고정하는 것으로 하나의 쓰레드면 변수의 읽고 쓰기를 할 수 있도록 변경할 수 있다.

https://www.brianstorti.com/the-actor-model/
https://tourspace.tistory.com/163

![image](https://user-images.githubusercontent.com/31586979/156491234-2448f8f3-2071-475e-8cb2-b5e5f10e5912.png)

### Mutex

Mutex는 우리가 일반적으로 임계 영역을 설정할 때 사용하고 있는 Mutex와 동일하다. </br>
Corotine에서의 차이점이 있다면 lock 메소드가 일시 중지 메소드인 것 뿐이다. </br>
